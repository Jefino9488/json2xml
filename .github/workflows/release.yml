name: Build and Release JAR

# This workflow runs when you push a new tag (e.g., v1.0)
on:
  push:
    tags:
      - 'v*' # Trigger on any tag starting with 'v'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    # These permissions are required for the action to create a release
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          # Your pom.xml maven-compiler-plugin is set to Java 21
          java-version: '21'
          distribution: 'temurin'
          # Cache Maven dependencies to speed up future builds
          cache: 'maven'

      - name: Get Version from Tag
        # This action strips the 'v' prefix from your tag (e.g., v1.0.1 -> 1.0.1)
        # and saves it as an environment variable called $VERSION
        run: echo "VERSION=${{ github.ref_name_without_v }}" >> $GITHUB_ENV

      - name: Set Project Version
        # This command updates the <version> in your pom.xml to match the tag
        # e.g., <version>1.0-SNAPSHOT</version> becomes <version>1.0.1</version>
        run: mvn versions:set -DnewVersion=${{ env.VERSION }}

      - name: Build with Maven
        # This builds the project and creates the shaded JAR
        # The file will be named like 'json2xml-1.0.1.jar'
        run: mvn clean package

      - name: Create GitHub Release and Upload JAR
        # This action creates a new "Release" on your GitHub repo
        # and uploads the JAR file as an asset to that release.
        uses: softprops/action-gh-release@v2
        with:
          # This tells the action which file(s) to upload.
          # It uses the $VERSION variable from earlier to find the correct JAR.
          files: target/json2xml-${{ env.VERSION }}.jar
        env:
          # The GITHUB_TOKEN is automatically provided by GitHub
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
